#!/bin/bash

# pre-commit hook - Valide et corrige le code avant chaque commit

echo "ğŸ” Validation et correction du code..."

# Obtenir la liste des fichiers modifiÃ©s PHP
CHANGED_FILES=$(git diff --cached --diff-filter=ACMR --name-only | grep '\.php$' | grep -E '^src/|^tests/')

if [ -z "$CHANGED_FILES" ]; then
    echo "âœ… Aucun fichier PHP Ã  vÃ©rifier"
    exit 0
fi

echo "ğŸ“ Fichiers PHP dÃ©tectÃ©s: $(echo $CHANGED_FILES | wc -w)"

# 1. Corriger automatiquement le code avec php-cs-fixer
echo ""
echo "ğŸ”§ Correction automatique du code..."
docker compose exec -T php composer cs:fix 2>/dev/null

if [ $? -ne 0 ]; then
    echo "âš ï¸  php-cs-fixer n'a pas pu corriger le code"
    exit 0
fi

# Re-ajouter les fichiers corrigÃ©s Ã  git
git add $CHANGED_FILES 2>/dev/null

# 2. Analyser le code avec PHPStan
echo ""
echo "ğŸ”¬ Analyse statique du code (PHPStan)..."
docker compose exec -T php composer phpstan:check 2>&1 | tee /tmp/phpstan-output.txt

PHPSTAN_RESULT=${PIPESTATUS[0]}

if [ $PHPSTAN_RESULT -ne 0 ]; then
    echo ""
    echo "âŒ PHPStan a trouvÃ© des erreurs !"
    echo "ğŸ‘‰ Pour continuer malgrÃ© les erreurs, utiliser: git commit --no-verify"
    exit 1
fi

echo ""
echo "âœ… Tout est bon ! Le code peut Ãªtre committÃ©"
exit 0
